# 静置检测与自动温度控制功能实现总结

## 1. 项目目标

实现基于6轴传感器的静置检测功能，当设备静置一段时间后自动降低温度，再静置更长时间后停止加热。同时实现设备运动检测，自动恢复加热功能。

## 2. 功能实现过程

### 2.1 初始实现
- 在 [St1xStatic.c](file:///D:/Leon/OneDrive/Leon/St1x/Software/St1xDrivers/St1xStatic.c) 中实现基于LIS2DW12 6轴传感器的静置检测功能
- 设置默认参数：15分钟后降低温度至160°C，30分钟后停止加热
- 实现传感器数据读取、运动检测算法和温度控制逻辑

### 2.2 编译与链接问题修复
- 修复了函数声明和定义不匹配的问题
- 解决了静态函数访问权限问题
- 添加了必要的头文件包含和外部变量声明

### 2.3 调试信息显示
- 实现在OLED屏幕上显示调试信息，位置为X15, Y26
- 显示内容包括：加速度值、静置状态、加热状态和距离上次运动时间

### 2.4 算法优化
- 优化运动检测阈值，从300mg降低到150mg，提高检测灵敏度
- 改进传感器数据读取方式，确保每次检测都读取最新数据
- 解决时间计数器溢出问题，只在加热状态下进行静置检测

## 3. 遇到的主要问题及解决方案

### 3.1 传感器检测不灵敏
**问题**：设备无法正确进入静置状态，始终检测到运动
**解决方案**：
- 降低运动检测阈值从300mg到150mg
- 改进算法，区分传感器噪声和真实运动
- 添加误差阈值机制，过滤小幅数值跳变

### 3.2 时间计数问题
**问题**：静置时间无法正确累积，L值在0和1之间跳变
**解决方案**：
- 优化时间计算逻辑，避免因小幅跳变重置时间计数器
- 区分噪声阈值和运动检测阈值
- 确保时间累积的稳定性

### 3.3 加热控制问题
**问题**：达到设定时间后无法降低温度或停止加热
**解决方案**：
- 修复加热控制回调函数中的提前返回问题
- 确保温度设置在加热状态停止前完成
- 调整参数单位从分钟改为秒，提高调试效率

### 3.4 自动恢复问题
**问题**：设备停止加热后无法通过运动检测自动恢复
**解决方案**：
- 修改主循环调用逻辑，始终执行静置检测
- 区分自动停止和手动停止状态
- 实现手动停止标记机制，提升用户体验

## 4. 功能增强

### 4.1 手动/自动停止区分
- 添加手动停止标记，区分用户按键停止和自动停止
- 手动停止后不自动恢复加热，需要用户再次按键启动
- 自动停止后检测到运动可自动恢复加热

### 4.2 参数配置优化
- 提供默认参数配置函数，便于通过宏定义调整参数
- 统一时间单位为秒，提高调试效率
- 简化参数设置接口

### 4.3 调试信息优化
- 简化调试显示内容，只保留关键信息
- 确保调试信息与实际状态一致
- 停止加热后相关时间值归零，避免误导

## 5. 最终功能效果

1. **静置检测**：设备静置15分钟后自动降低温度至160°C，30分钟后停止加热
2. **运动检测**：设备运动时自动恢复加热状态
3. **状态区分**：自动停止后可自动恢复，手动停止后需手动启动
4. **调试显示**：在OLED屏幕指定位置显示关键状态信息
5. **安全保护**：防止用户初次上电时意外加热造成伤害

## 6. 技术要点总结

- 有效利用6轴传感器的三轴数据进行运动检测
- 实现噪声过滤算法，提高检测准确性
- 合理设计状态机，确保各状态转换正确
- 区分自动和手动操作，提升用户体验
- 优化资源使用，避免不必要的系统消耗

## 7. 经验教训

1. 传感器数据处理需要考虑噪声影响，不能直接使用原始数据
2. 时间计数逻辑需要仔细设计，避免因小幅波动影响计时准确性
3. 加热控制逻辑需要考虑回调函数的执行条件
4. 用户体验需要细致考虑，区分不同场景下的行为
5. 调试信息要准确反映系统状态，避免误导开发者或用户